{% comment %}
  SECCI√ìN: Importador de productos Sephora ‚Äî Mak Beauty v2
  
  INSTALACI√ìN EN SHOPIFY (OS 2.0):
  1. Admin ‚Üí Online Store ‚Üí Themes ‚Üí Edit code
  2. En "Sections" ‚Üí sephora-import.liquid ‚Üí pegar TODO esto
  3. Guardar
{% endcomment %}

<style>
  .mk-importer {
    --mk-pink: #E48DA5;
    --mk-pink-dark: #D4729A;
    --mk-pink-light: #FDF2F5;
    --mk-pink-soft: #F8D7E0;
    --mk-accent: #C96B8B;
    --mk-text: #2D2D2D;
    --mk-text-muted: #7A7A7A;
    --mk-bg: #FAFAFA;
    --mk-white: #FFFFFF;
    --mk-border: #F0E0E5;
    --mk-success: #7CB69D;
    --mk-radius: 16px;
    --mk-shadow: 0 4px 20px rgba(228, 141, 165, 0.12);
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    max-width: 1100px;
    margin: 0 auto;
    padding: 30px 20px 60px;
    color: var(--mk-text);
  }

  /* ‚Äî Header ‚Äî */
  .mk-header { text-align: center; margin-bottom: 32px; }
  .mk-header h2 { font-size: 28px; font-weight: 700; margin: 0 0 6px; }
  .mk-header p { font-size: 14px; color: var(--mk-text-muted); margin: 0; }

  /* ‚Äî B√∫squeda ‚Äî */
  .mk-search {
    background: var(--mk-white); border-radius: var(--mk-radius);
    padding: 24px; box-shadow: var(--mk-shadow); margin-bottom: 28px;
    border: 1px solid var(--mk-border);
  }
  .mk-search-label {
    font-size: 13px; font-weight: 600; color: var(--mk-pink-dark);
    margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .mk-search-row { display: flex; gap: 12px; }
  .mk-search-input {
    flex: 1; padding: 14px 20px; border: 2px solid var(--mk-border);
    border-radius: 12px; font-size: 14px; font-family: inherit;
    transition: border-color 0.2s; background: var(--mk-bg);
  }
  .mk-search-input:focus { border-color: var(--mk-pink); outline: none; background: var(--mk-white); }
  .mk-search-input::placeholder { color: #C0A8B0; }
  .mk-btn-buscar {
    padding: 14px 32px;
    background: linear-gradient(135deg, var(--mk-pink), var(--mk-pink-dark));
    color: var(--mk-white); border: none; border-radius: 12px;
    font-size: 14px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: transform 0.15s, box-shadow 0.2s; white-space: nowrap;
  }
  .mk-btn-buscar:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(212,114,154,0.4); }
  .mk-btn-buscar:disabled { background: #D4C5CA; cursor: not-allowed; transform: none; }
  .mk-alert {
    display: none; background: #FFF8E1; border: 1px solid #FFD54F;
    border-radius: 10px; padding: 10px 16px; margin-top: 12px; font-size: 13px; color: #8D6E00;
  }

  /* ‚Äî Loading / Welcome ‚Äî */
  .mk-loading { display: none; text-align: center; padding: 70px 20px; }
  .mk-loading.visible { display: block; }
  .mk-loader {
    width: 44px; height: 44px; border: 4px solid var(--mk-pink-soft);
    border-top-color: var(--mk-pink-dark); border-radius: 50%;
    animation: mk-spin 0.7s linear infinite; margin: 0 auto 18px;
  }
  @keyframes mk-spin { to { transform: rotate(360deg); } }
  .mk-loading p { font-size: 14px; color: var(--mk-text-muted); }

  .mk-welcome {
    text-align: center; padding: 60px 20px; background: var(--mk-white);
    border-radius: var(--mk-radius); border: 2px dashed var(--mk-border);
  }
  .mk-welcome-icon {
    width: 64px; height: 64px; background: var(--mk-pink-light);
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; margin: 0 auto 16px; font-size: 28px;
  }
  .mk-welcome h3 { font-size: 20px; font-weight: 600; margin: 0 0 8px; }
  .mk-welcome p { font-size: 14px; color: var(--mk-text-muted); max-width: 380px; margin: 0 auto; line-height: 1.5; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRODUCTO LAYOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .mk-product { display: none; }
  .mk-product.visible {
    display: grid; grid-template-columns: 1fr 400px; gap: 28px; align-items: start;
  }
  .mk-panel {
    background: var(--mk-white); border-radius: var(--mk-radius);
    box-shadow: var(--mk-shadow); padding: 28px; border: 1px solid var(--mk-border);
  }

  /* ‚Äî Galer√≠a estilo Sephora ‚Äî */
  .mk-gallery { display: grid; grid-template-columns: 72px 1fr; gap: 12px; margin-bottom: 20px; }
  .mk-gallery-thumbs {
    display: flex; flex-direction: column; gap: 8px;
    max-height: 500px; overflow-y: auto; scrollbar-width: thin;
    scrollbar-color: var(--mk-pink-soft) transparent;
  }
  .mk-gallery-thumbs::-webkit-scrollbar { width: 4px; }
  .mk-gallery-thumbs::-webkit-scrollbar-thumb { background: var(--mk-pink-soft); border-radius: 4px; }
  .mk-gallery-thumb {
    width: 64px; height: 64px; border-radius: 8px; object-fit: cover;
    border: 2px solid var(--mk-border); cursor: pointer;
    transition: border-color 0.2s, transform 0.15s; flex-shrink: 0;
  }
  .mk-gallery-thumb:hover { border-color: var(--mk-pink); transform: scale(1.05); }
  .mk-gallery-thumb.active { border-color: var(--mk-pink-dark); box-shadow: 0 0 0 2px var(--mk-pink-soft); }
  .mk-gallery-main {
    width: 100%; aspect-ratio: 1; border-radius: 14px; overflow: hidden;
    background: var(--mk-bg); display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .mk-gallery-main img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
  .mk-gallery-main img:hover { transform: scale(1.05); }
  .mk-img-count {
    position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6);
    color: #fff; font-size: 11px; padding: 4px 10px; border-radius: 20px;
  }

  /* ‚Äî Gallery loading overlay ‚Äî */
  .mk-gallery-main { position: relative; }
  .mk-gallery-overlay {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.88); backdrop-filter: blur(6px);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; gap: 10px; border-radius: 14px; z-index: 5;
  }
  .mk-gallery-overlay.visible { display: flex; }
  .mk-gallery-overlay .mk-go-spinner {
    width: 36px; height: 36px; border: 3px solid var(--mk-pink-soft);
    border-top-color: var(--mk-pink-dark); border-radius: 50%;
    animation: mk-spin 0.6s linear infinite;
  }
  .mk-gallery-overlay .mk-go-text {
    font-size: 12px; color: var(--mk-text-muted); font-weight: 500;
  }

  /* ‚Äî Unified variant grid (swatches + chips combined) ‚Äî */
  .mk-variants-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    margin-bottom: 18px; max-height: 340px; overflow-y: auto;
    scrollbar-width: thin; scrollbar-color: var(--mk-pink-soft) transparent;
  }
  .mk-variants-grid::-webkit-scrollbar { width: 4px; }
  .mk-variants-grid::-webkit-scrollbar-thumb { background: var(--mk-pink-soft); border-radius: 4px; }
  .mk-variant-card {
    border: 2px solid var(--mk-border); border-radius: 12px;
    padding: 10px 6px; text-align: center; cursor: pointer;
    transition: all 0.2s; background: var(--mk-white);
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    min-height: 60px; justify-content: center;
  }
  .mk-variant-card:hover { border-color: var(--mk-pink); background: var(--mk-pink-light); }
  .mk-variant-card.picked { border-color: var(--mk-pink-dark); background: var(--mk-pink-light); box-shadow: 0 0 0 1px var(--mk-pink-dark); }
  .mk-variant-card.oos { opacity: 0.4; text-decoration: line-through; cursor: not-allowed; }
  .mk-variant-card.loading { pointer-events: none; opacity: 0.6; }
  .mk-vc-img {
    width: 38px; height: 38px; border-radius: 50%; object-fit: cover;
    border: 2px solid var(--mk-border); flex-shrink: 0;
  }
  .mk-variant-card.picked .mk-vc-img { border-color: var(--mk-pink-dark); }
  .mk-vc-label { font-size: 12px; font-weight: 600; line-height: 1.25; color: var(--mk-text); }
  .mk-vc-desc { font-size: 10px; color: var(--mk-text-muted); line-height: 1.2; }
  .mk-vc-price { font-size: 11px; color: var(--mk-pink-dark); font-weight: 700; }

  /* ‚Äî Info ‚Äî */
  .mk-brand {
    font-size: 13px; font-weight: 700; color: var(--mk-pink-dark);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;
  }
  .mk-title { font-size: 20px; font-weight: 700; margin: 0 0 6px; line-height: 1.3; }
  .mk-rating { font-size: 13px; color: var(--mk-text-muted); margin-bottom: 10px; }
  .mk-rating .stars { color: #FFB800; letter-spacing: 1px; }
  .mk-price-inline {
    font-size: 22px; font-weight: 800; color: var(--mk-text); margin-bottom: 6px;
  }
  .mk-color-label { font-size: 13px; color: var(--mk-text-muted); margin-bottom: 16px; }
  .mk-color-label strong { color: var(--mk-text); }
  .mk-variant-price { font-size: 12px; color: var(--mk-pink-dark); font-weight: 600; margin-left: 6px; }

  .mk-field-label {
    display: block; font-size: 12px; font-weight: 600; color: var(--mk-text-muted);
    margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .mk-field {
    width: 100%; padding: 10px 14px; border: 1.5px solid var(--mk-border);
    border-radius: 10px; font-size: 14px; font-family: inherit;
    background: var(--mk-bg); margin-bottom: 14px; box-sizing: border-box;
  }
  .mk-field:focus { border-color: var(--mk-pink); outline: none; }

  /* (variant chips merged into mk-variants-grid above) */

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL DERECHO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .mk-summary { position: sticky; top: 20px; }
  .mk-summary-title {
    font-size: 16px; font-weight: 700; margin-bottom: 16px;
    padding-bottom: 12px; border-bottom: 2px solid var(--mk-pink-soft);
  }

  /* ‚Äî Desglose ‚Äî */
  .mk-bd { margin-bottom: 16px; }
  .mk-bd-section { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--mk-border); }
  .mk-bd-section:last-child { border-bottom: none; margin-bottom: 0; }
  .mk-bd-header {
    font-size: 11px; font-weight: 700; color: var(--mk-pink-dark);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px;
  }
  .mk-bd-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 13px; }
  .mk-bd-row .lbl { color: var(--mk-text-muted); }
  .mk-bd-row .val { font-weight: 600; color: var(--mk-text); }
  .mk-bd-row .val.free { color: var(--mk-success); }
  .mk-bd-row .val.hl { color: var(--mk-pink-dark); font-weight: 700; }
  .mk-bd-sub {
    display: flex; justify-content: space-between; padding: 6px 0 0;
    margin-top: 4px; border-top: 1px dashed var(--mk-border);
  }
  .mk-bd-sub .lbl { font-weight: 600; font-size: 13px; }
  .mk-bd-sub .val { font-weight: 700; color: var(--mk-pink-dark); font-size: 13px; }
  .mk-bd-total {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 0 0; margin-top: 4px; border-top: 2px solid var(--mk-pink-dark);
  }
  .mk-bd-total .lbl { font-size: 15px; font-weight: 700; }
  .mk-bd-total .val { font-size: 26px; font-weight: 800; color: var(--mk-pink-dark); }

  /* ‚Äî Delivery ‚Äî */
  .mk-delivery-box {
    background: linear-gradient(135deg, #F0FAF4, #E8F5EE);
    border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; border: 1px solid #C8E6D0;
  }
  .mk-delivery-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
  .mk-delivery-date { font-weight: 700; color: #3D8B5E; font-size: 14px; }

  /* ‚Äî Qty ‚Äî */
  .mk-qty-section {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; padding: 12px 16px; background: var(--mk-pink-light); border-radius: 12px;
  }
  .mk-qty-label { font-size: 14px; font-weight: 600; }
  .mk-qty-controls { display: flex; align-items: center; gap: 14px; }
  .mk-qty-btn {
    width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--mk-border);
    background: var(--mk-white); font-size: 18px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    color: var(--mk-text); font-family: inherit;
  }
  .mk-qty-btn:hover { border-color: var(--mk-pink); background: var(--mk-pink-light); }
  .mk-qty-num { font-size: 20px; font-weight: 700; min-width: 30px; text-align: center; }

  /* ‚Äî Buttons ‚Äî */
  .mk-btn-comprar {
    width: 100%; padding: 16px;
    background: linear-gradient(135deg, var(--mk-pink), var(--mk-pink-dark));
    color: var(--mk-white); border: none; border-radius: 14px;
    font-size: 16px; font-weight: 700; font-family: inherit; cursor: pointer;
    margin-bottom: 10px; transition: transform 0.15s, box-shadow 0.2s;
  }
  .mk-btn-comprar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,114,154,0.35); }
  .mk-btn-carrito {
    width: 100%; padding: 14px; background: var(--mk-white);
    color: var(--mk-pink-dark); border: 2px solid var(--mk-pink);
    border-radius: 14px; font-size: 15px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: all 0.2s; margin-bottom: 14px;
  }
  .mk-btn-carrito:hover { background: var(--mk-pink-light); }
  .mk-secure {
    display: flex; align-items: center; justify-content: center;
    gap: 6px; font-size: 12px; color: var(--mk-text-muted);
  }

  .mk-notes-section { margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--mk-border); }

  /* ‚Äî Responsive ‚Äî */
  @media (max-width: 820px) {
    .mk-product.visible { grid-template-columns: 1fr; }
    .mk-search-row { flex-direction: column; }
    .mk-summary { position: static; }
    .mk-gallery { grid-template-columns: 56px 1fr; gap: 8px; }
    .mk-gallery-thumb { width: 48px; height: 48px; }
    .mk-gallery-thumbs { max-height: 350px; }
  }
</style>

<div class="mk-importer">
  <div class="mk-header">
    <h2>Importar desde Sephora USA</h2>
    <p>Pega el enlace del producto y te lo traemos hasta tu puerta</p>
  </div>

  <div class="mk-search">
    <div class="mk-search-label">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      Pega el link del producto de Sephora
    </div>
    <div class="mk-search-row">
      <input type="text" class="mk-search-input" id="mk-url" placeholder="https://www.sephora.com/product/...">
      <button class="mk-btn-buscar" id="mk-btn" onclick="mkBuscar()">Buscar Producto</button>
    </div>
    <div class="mk-alert" id="mk-alert"></div>
  </div>

  <div class="mk-loading" id="mk-loading">
    <div class="mk-loader"></div>
    <p id="mk-loading-msg">Conectando con Sephora...</p>
  </div>

  <div class="mk-welcome" id="mk-welcome">
    <div class="mk-welcome-icon">‚ú®</div>
    <h3>Tu pr√≥ximo favorito te espera</h3>
    <p>Copia el enlace de cualquier producto de sephora.com y p√©galo arriba. Nosotros hacemos el resto.</p>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRODUCTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="mk-product" id="mk-product">
    <!-- PANEL IZQUIERDO -->
    <div class="mk-panel">
      <div class="mk-gallery">
        <div class="mk-gallery-thumbs" id="mk-gallery-thumbs"></div>
        <div class="mk-gallery-main">
          <img id="mk-main-img" src="" alt="Producto">
          <span class="mk-img-count" id="mk-img-count"></span>
          <div class="mk-gallery-overlay" id="mk-gallery-overlay">
            <div class="mk-go-spinner"></div>
            <span class="mk-go-text">Cargando im√°genes...</span>
          </div>
        </div>
      </div>

      <div class="mk-brand" id="mk-brand"></div>
      <h3 class="mk-title" id="mk-title"></h3>
      <div class="mk-rating" id="mk-rating" style="display:none;"></div>
      <div class="mk-price-inline" id="mk-price-inline"></div>
      <div class="mk-color-label" id="mk-color-label" style="display:none;"></div>

      <div id="mk-variants-wrap" style="display:none;">
        <label class="mk-field-label" id="mk-variants-label">Tono / Variante</label>
        <div class="mk-variants-grid" id="mk-variants-grid"></div>
      </div>

      <label class="mk-field-label">Categor√≠a</label>
      <div class="mk-field" id="mk-category" style="white-space:pre-line;min-height:38px;line-height:1.5;padding:8px 12px;font-size:13px;color:#555;">Maquillaje</div>

      <div class="mk-notes-section">
        <label class="mk-field-label">Indicaciones especiales</label>
        <textarea class="mk-field" id="mk-notes" rows="2" placeholder="Color exacto, talla, presentaci√≥n..."></textarea>
      </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="mk-panel mk-summary">
      <div class="mk-summary-title">Resumen de tu pedido</div>

      <div class="mk-bd">
        <div class="mk-bd-section">
          <div class="mk-bd-header">üá∫üá∏ Compra en USA</div>
          <div class="mk-bd-row"><span class="lbl">Producto(s)</span><span class="val" id="bd-prod">$ 0.00</span></div>
          <div class="mk-bd-row"><span class="lbl">Taxes (7%)</span><span class="val" id="bd-tax">$ 0.00</span></div>
          <div class="mk-bd-row"><span class="lbl">Env√≠o en tienda</span><span class="val free" id="bd-store-ship">Gratis</span></div>
          <div class="mk-bd-sub"><span class="lbl">Total en USA</span><span class="val" id="bd-usa">$ 0.00</span></div>
        </div>

        <div class="mk-bd-section">
          <div class="mk-bd-header">üáµüá™ Env√≠o a Per√∫</div>
          <div class="mk-bd-row"><span class="lbl">Env√≠o internacional <small id="bd-weight">(~0.5 Kg)</small></span><span class="val" id="bd-ship">$ 19.00</span></div>
          <div class="mk-bd-row"><span class="lbl">Impuestos importaci√≥n</span><span class="val free" id="bd-imp">Gratis</span></div>
          <div class="mk-bd-sub"><span class="lbl">Total tra√≠da</span><span class="val" id="bd-traida">$ 19.00</span></div>
        </div>

        <div class="mk-bd-section">
          <div class="mk-bd-header">üõ°Ô∏è Servicio Mak Beauty</div>
          <div class="mk-bd-row"><span class="lbl">Procesamiento</span><span class="val" id="bd-proc">$ 0.00</span></div>
          <div class="mk-bd-row"><span class="lbl">30 d√≠as de garant√≠a</span><span class="val free">Gratis</span></div>
        </div>

        <div class="mk-bd-section" style="border-bottom:none;">
          <div class="mk-bd-row"><span class="lbl" style="font-weight:600">Total (USD)</span><span class="val hl" id="bd-usd">$ 0.00</span></div>
          <div class="mk-bd-total"><span class="lbl">Total a pagar</span><span class="val" id="bd-pen">S/ 0.00</span></div>
        </div>
      </div>

      <div class="mk-delivery-box">
        <div class="mk-delivery-row">
          <span>Llega antes del</span>
          <span class="mk-delivery-date" id="mk-arrival">--</span>
        </div>
      </div>

      <div class="mk-qty-section">
        <span class="mk-qty-label">Cantidad:</span>
        <div class="mk-qty-controls">
          <button class="mk-qty-btn" onclick="mkQty(-1)">‚àí</button>
          <span class="mk-qty-num" id="mk-qty">1</span>
          <button class="mk-qty-btn" onclick="mkQty(1)">+</button>
        </div>
      </div>

      <button class="mk-btn-comprar" onclick="mkComprar()">Comprar ahora</button>
      <button class="mk-btn-carrito" onclick="mkAgregar()">Agregar al carrito</button>

      <div class="mk-secure">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Pago 100% seguro ¬∑ Garant√≠a de autenticidad
      </div>
    </div>
  </div>


</div>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONFIGURACI√ìN
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const MK_API = 'https://web-production-56b31.up.railway.app';
  const MK_RATE       = 3.45;
  const MK_TAX_RATE   = 0.07;
  const MK_INTL_SHIP  = 20.00;
  const MK_COMMISSION = 0.15;
  const MK_SYMBOL     = 'S/';
  const MK_VARIANT_ID = 51967182143801;

  let mkData = null, mkQtyVal = 1;
  let mkVariantImagesCache = {};  // { skuId: [urls] }
  let mkCurrentFetchController = null;
  let mkActiveRequest = null;

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUSCAR CON SSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  async function mkBuscar() {
    const url = document.getElementById('mk-url').value.trim();
    const al  = document.getElementById('mk-alert');
    const btn = document.getElementById('mk-btn');
    al.style.display = 'none';
    if (!url || !url.includes('sephora.com')) {
      al.textContent = 'Por favor ingresa un enlace v√°lido de sephora.com';
      al.style.display = 'block'; return;
    }
    const loadMsg = document.getElementById('mk-loading-msg');
    loadMsg.textContent = 'Conectando con Sephora...';
    document.getElementById('mk-loading').classList.add('visible');
    document.getElementById('mk-welcome').style.display = 'none';
    document.getElementById('mk-product').classList.remove('visible');
    btn.disabled = true; btn.textContent = 'Buscando...';
    mkVariantImagesCache = {};

    /* ‚îÄ‚îÄ Limpiar producto anterior ‚îÄ‚îÄ */
    document.getElementById('mk-brand').textContent = '';
    document.getElementById('mk-title').textContent = '';
    document.getElementById('mk-rating').style.display = 'none';
    document.getElementById('mk-price-inline').textContent = '';
    document.getElementById('mk-main-img').src = '';
    document.getElementById('mk-gallery-thumbs').innerHTML = '';
    document.getElementById('mk-img-count').textContent = '';
    document.getElementById('mk-variants-grid').innerHTML = '';
    document.getElementById('mk-variants-wrap').style.display = 'none';
    document.getElementById('mk-color-label').style.display = 'none';
    document.getElementById('mk-category').textContent = '';

    let gotProduct = false; // safety flag
    let gotError = false;

    try {
      const res = await fetch(`${MK_API}/api/scrape-stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      if (!res.ok || !res.headers.get('content-type')?.includes('text/event-stream')) {
        // Intentar respuesta JSON directa (no SSE)
        try {
          const data = await res.json();
          if (data && data.error) {
            al.textContent = data.error;
            al.style.display = 'block'; gotError = true;
          }
        } catch(_) {}
        if (!gotError) await mkBuscarClassic(url);
        gotProduct = document.getElementById('mk-product').classList.contains('visible');
        return;
      }
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      mkData = { success: false, url: url, images: [], color_variants: [] };

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const events = buffer.split('\n\n');
        buffer = events.pop();
        for (const evt of events) {
          if (!evt.trim()) continue;
          let eventType = 'message', eventData = '';
          for (const line of evt.split('\n')) {
            if (line.startsWith('event: ')) eventType = line.slice(7).trim();
            if (line.startsWith('data: ')) eventData = line.slice(6);
          }
          if (!eventData) continue;
          try {
            const payload = JSON.parse(eventData);
            if (eventType === 'basic') {
              loadMsg.textContent = 'Obteniendo im√°genes...';
              Object.assign(mkData, payload);
              mkRenderBasic(mkData);
              gotProduct = true;
            } else if (eventType === 'images') {
              loadMsg.textContent = 'Cargando variantes...';
              mkData.images = payload.images || [];
              mkRenderImages(mkData.images);
            } else if (eventType === 'variants') {
              mkData.color_variants = payload.color_variants || [];
              mkRenderVariants(mkData);
            } else if (eventType === 'complete') {
              mkData = payload; mkData.success = true;
              mkRecalc();
              gotProduct = true;
            } else if (eventType === 'error') {
              al.textContent = payload.error || 'Error al obtener producto.';
              al.style.display = 'block';
              gotError = true;
            }
          } catch(e) { console.warn('SSE parse:', e); }
        }
      }
    } catch(e) {
      console.warn('SSE failed:', e);
      if (!gotProduct) {
        try { await mkBuscarClassic(url); gotProduct = document.getElementById('mk-product').classList.contains('visible'); } catch(e2) {
          al.textContent = 'Error de conexi√≥n. El servidor puede estar iniciando, intenta en 30 segundos.';
          al.style.display = 'block';
          gotError = true;
        }
      }
    } finally {
      document.getElementById('mk-loading').classList.remove('visible');
      btn.disabled = false; btn.textContent = 'Buscar Producto';
      // SAFETY NET: si no se renderiz√≥ nada, re-mostrar welcome
      if (!gotProduct) {
        document.getElementById('mk-welcome').style.display = '';
        if (!gotError) {
          al.textContent = 'No se pudo conectar con el servidor. Puede estar iniciando ‚Äî intenta de nuevo en unos segundos.';
          al.style.display = 'block';
        }
      }
    }
  }

  async function mkBuscarClassic(url) {
    const al = document.getElementById('mk-alert');
    const res = await fetch(`${MK_API}/api/scrape`, {
      method: 'POST', headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ url })
    });
    const data = await res.json();
    if (!data.success) {
      al.textContent = data.error || 'No pudimos obtener el producto.';
      al.style.display = 'block';
      document.getElementById('mk-welcome').style.display = ''; return;
    }
    mkData = data;
    mkRenderBasic(data);
    mkRenderImages(data.images || []);
    mkRenderVariants(data);
    mkRecalc();
  }

  document.getElementById('mk-url').addEventListener('keydown', e => { if (e.key === 'Enter') mkBuscar(); });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER PROGRESIVO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  function mkRenderBasic(d) {
    document.getElementById('mk-brand').textContent = d.brand || '';
    document.getElementById('mk-title').textContent = d.name || '';
    const ratingEl = document.getElementById('mk-rating');
    if (d.rating) {
      const full = Math.floor(d.rating), half = d.rating - full >= 0.3 ? '¬Ω' : '';
      ratingEl.innerHTML = `<span class="stars">${'‚òÖ'.repeat(full)}${half}${'‚òÜ'.repeat(5-full-(half?1:0))}</span> ${d.rating} ¬∑ ${d.review_count||0} rese√±as`;
      ratingEl.style.display = '';
    } else ratingEl.style.display = 'none';
    document.getElementById('mk-price-inline').textContent = d.price || '';
    const catEl = document.getElementById('mk-category');
    catEl.textContent = d.category || 'Maquillaje';
    const arr = new Date(); arr.setDate(arr.getDate() + 21);
    const m = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    document.getElementById('mk-arrival').textContent = `${arr.getDate()} de ${m[arr.getMonth()]} del ${arr.getFullYear()}`;
    mkQtyVal = 1; document.getElementById('mk-qty').textContent = '1';
    mkRecalc();
    document.getElementById('mk-product').classList.add('visible');
    document.getElementById('mk-welcome').style.display = 'none';
  }

  /* ‚îÄ‚îÄ Im√°genes de galer√≠a ‚îÄ‚îÄ */
  function mkRenderImages(imgs) {
    const mainImg = document.getElementById('mk-main-img');
    const gThumbs = document.getElementById('mk-gallery-thumbs');
    gThumbs.innerHTML = '';
    if (!imgs || imgs.length === 0) return;
    mainImg.src = imgs[0];
    document.getElementById('mk-img-count').textContent = imgs.length + ' fotos';
    imgs.forEach((url, i) => {
      const t = document.createElement('img');
      t.src = url; t.className = 'mk-gallery-thumb' + (i===0?' active':'');
      t.loading = 'lazy';
      t.onclick = () => {
        mainImg.onerror = null; mainImg.src = url;
        gThumbs.querySelectorAll('.mk-gallery-thumb').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
      };
      t.onerror = function(){ this.style.display='none'; };
      gThumbs.appendChild(t);
    });
  }

  /* ‚îÄ‚îÄ Variantes (grid unificado) ‚îÄ‚îÄ */
  function mkRenderVariants(d) {
    const variants = d.color_variants || [];
    const grid = document.getElementById('mk-variants-grid');
    const wrap = document.getElementById('mk-variants-wrap');
    grid.innerHTML = '';
    if (variants.length === 0) { wrap.style.display = 'none'; return; }

    const isSize = variants.some(v => /oz|ml|g\b|fl/i.test(v.label||''));
    wrap.style.display = '';
    document.getElementById('mk-variants-label').textContent = isSize ? 'Tama√±o / Presentaci√≥n' : 'Tono / Variante';

    // Ajustar columnas seg√∫n cantidad
    if (variants.length <= 4) grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
    else grid.style.gridTemplateColumns = 'repeat(3, 1fr)';

    variants.forEach((v, i) => {
      const card = document.createElement('div');
      const lbl = (v.label||`Variante ${i+1}`).replace(/^Select\s*/i,'');
      card.className = 'mk-variant-card' + (v.selected?' picked':'') + (v.out_of_stock?' oos':'');
      card.dataset.idx = i;

      // Contenido de la card
      let html = '';
      const swatchSrc = v.swatch || v.image;
      if (swatchSrc) {
        html += `<img class="mk-vc-img" src="${swatchSrc}" loading="lazy" onerror="this.style.display='none'">`;
      }
      // Separar nombre y descripci√≥n heur√≠sticamente
      const words = lbl.split(' ');
      let name = lbl, desc = '';
      if (words.length > 2) {
        name = words.slice(0,2).join(' ');
        desc = words.slice(2).join(' ');
      }
      html += `<span class="mk-vc-label">${name}</span>`;
      if (desc) html += `<span class="mk-vc-desc">${desc}</span>`;
      if (v.price && v.price > 0) html += `<span class="mk-vc-price">$${v.price.toFixed(2)}</span>`;
      card.innerHTML = html;

      if (!v.out_of_stock) {
        card.onclick = async () => {
          // Cancelar request anterior si existe
          if (mkActiveRequest) mkActiveRequest.cancelled = true;
          const thisRequest = { cancelled: false };
          mkActiveRequest = thisRequest;

          // Marcar tono seleccionado
          grid.querySelectorAll('.mk-variant-card').forEach(x => x.classList.remove('picked'));
          card.classList.add('picked');

          // Actualizar precio y label
          const isSize = variants.some(vr => /oz|ml|g\b|fl/i.test(vr.label||''));
          const lbl = (v.label||'').replace(/^Select\s*/i,'');
          if (v.price && v.price > 0) {
            mkData.price_numeric = v.price;
            document.getElementById('mk-price-inline').textContent = '$' + v.price.toFixed(2);
          }
          mkUpdateColorLabel(lbl, isSize);
          mkRecalc();

          // Mostrar loading en imagen principal
          const mainImg = document.getElementById('mk-main-img');
          const thumbs = document.getElementById('mk-gallery-thumbs');
          mainImg.style.opacity = '0.4';
          mainImg.style.transition = 'opacity 0.2s';

          // Fallback inmediato: mostrar swatch mientras carga
          if (v.swatch) {
            mainImg.src = v.swatch.replace('-swatch', '-zoom').replace('_swatch', '_zoom');
          } else if (v.image) {
            mainImg.src = mkToFullImage(v.image);
          }

          if (v.sku_id) {
            // Usar im√°genes pre-extra√≠das del scrape inicial
            if (v.images && v.images.length > 1) {
              mkVariantImagesCache[v.sku_id] = v.images;
              mkRenderImages(v.images);
              mainImg.style.opacity = '1';
              return;
            }
            // Cache local
            if (mkVariantImagesCache[v.sku_id]) {
              mkRenderImages(mkVariantImagesCache[v.sku_id]);
              mainImg.style.opacity = '1';
              return;
            }

            try {
              const res = await fetch(`${MK_API}/api/variant-images`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({ url: mkData.url, sku_id: v.sku_id })
              });
              const data = await res.json();

              // Si el usuario ya cambi√≥ de variante, ignorar
              if (thisRequest.cancelled) return;

              if (data.success && data.images && data.images.length > 0) {
                mkVariantImagesCache[v.sku_id] = data.images;
                // Actualizar imagen principal
                mainImg.src = data.images[0];
                mainImg.style.opacity = '1';

                // Actualizar miniaturas
                thumbs.innerHTML = '';
                document.getElementById('mk-img-count').textContent = data.images.length + ' fotos';
                data.images.forEach((imgUrl, idx) => {
                  const img = document.createElement('img');
                  img.src = imgUrl;
                  img.className = 'mk-gallery-thumb' + (idx === 0 ? ' active' : '');
                  img.loading = 'lazy';
                  img.onclick = () => {
                    mainImg.src = imgUrl;
                    thumbs.querySelectorAll('.mk-gallery-thumb').forEach(t => t.classList.remove('active'));
                    img.classList.add('active');
                  };
                  img.onerror = function() { this.style.display = 'none'; };
                  thumbs.appendChild(img);
                });

                // Actualizar precio si la variante tiene precio diferente
                if (v.price && v.price > 0) {
                  mkData.price_numeric = v.price;
                  document.getElementById('mk-price-inline').textContent = '$' + v.price.toFixed(2);
                  mkRecalc();
                }
              } else {
                mainImg.style.opacity = '1';
              }
            } catch(e) {
              if (!thisRequest.cancelled) {
                mainImg.style.opacity = '1';
              }
            }
          } else {
            mainImg.style.opacity = '1';
          }
        };
      }
      grid.appendChild(card);
    });

    // Seleccionar la variante activa
    const sel = variants.find(v => v.selected);
    if (sel) {
      mkUpdateColorLabel(sel.label, isSize);
      if (sel.price && sel.price > 0) {
        mkData.price_numeric = sel.price;
        document.getElementById('mk-price-inline').textContent = '$' + sel.price.toFixed(2);
      }
    }
  }

  /* ‚îÄ‚îÄ Helpers de imagen ‚îÄ‚îÄ */
  function mkToFullImage(url) {
    if (!url) return '';
    if (url.includes('-main-zoom')) return url;
    if (url.includes('+sw')) return url.replace(/\+sw\.[^.]+$/, '-main-zoom.jpg');
    const m = url.match(/\/s(\d+)\./);
    if (m) return `https://www.sephora.com/productimages/sku/s${m[1]}-main-zoom.jpg`;
    return url;
  }

  function mkUpdateColorLabel(lbl, isSize) {
    const el = document.getElementById('mk-color-label');
    if (lbl) {
      el.innerHTML = `${isSize?'Tama√±o':'Color'}: <strong>${lbl.replace(/^Select\s*/i,'')}</strong>`;
      el.style.display = '';
    } else el.style.display = 'none';
  }

  /* ‚îÄ‚îÄ Recalcular precios ‚îÄ‚îÄ */
  function mkRecalc() {
    const price = mkData ? (mkData.price_numeric || 0) : 0;
    const q = mkQtyVal;
    const prod = price * q, tax = prod * MK_TAX_RATE, sShip = 0;
    const usa = prod + tax + sShip, intl = MK_INTL_SHIP, imp = 0;
    const traida = intl + imp, proc = prod * MK_COMMISSION;
    const usd = usa + traida + proc, pen = usd * MK_RATE;

    document.getElementById('bd-prod').textContent      = `$ ${prod.toFixed(2)}`;
    document.getElementById('bd-tax').textContent        = `$ ${tax.toFixed(2)}`;
    document.getElementById('bd-store-ship').textContent = sShip > 0 ? `$ ${sShip.toFixed(2)}` : 'Gratis';
    document.getElementById('bd-store-ship').className   = 'val' + (sShip===0?' free':'');
    document.getElementById('bd-usa').textContent        = `$ ${usa.toFixed(2)}`;
    document.getElementById('bd-ship').textContent       = `$ ${intl.toFixed(2)}`;
    document.getElementById('bd-imp').textContent        = imp > 0 ? `$ ${imp.toFixed(2)}` : 'Gratis';
    document.getElementById('bd-imp').className          = 'val' + (imp===0?' free':'');
    document.getElementById('bd-traida').textContent     = `$ ${traida.toFixed(2)}`;
    document.getElementById('bd-proc').textContent       = `$ ${proc.toFixed(2)}`;
    document.getElementById('bd-usd').textContent        = `$ ${usd.toFixed(2)}`;
    document.getElementById('bd-pen').textContent        = `${MK_SYMBOL} ${pen.toFixed(2)}`;
  }

  function mkQty(d) { mkQtyVal = Math.max(1, mkQtyVal + d); document.getElementById('mk-qty').textContent = mkQtyVal; mkRecalc(); }

  function mkGetSelectedVariant() {
    const card = document.querySelector('.mk-variant-card.picked');
    if (!card) return { label: 'N/A', sku_id: '' };
    const lblEl = card.querySelector('.mk-vc-label');
    const descEl = card.querySelector('.mk-vc-desc');
    const idx = parseInt(card.dataset.idx || '0');
    const v = (mkData.color_variants || [])[idx] || {};
    return {
      label: lblEl ? (lblEl.textContent + (descEl ? ' ' + descEl.textContent : '')) : 'N/A',
      sku_id: v.sku_id || '',
      image: v.image || '',
    };
  }

  function mkProps() {
    const sv = mkGetSelectedVariant();
    const mainImg = document.getElementById('mk-main-img');
    const imgUrl = (mkData.images && mkData.images[0]) || (mainImg ? mainImg.src : '');
    return {
      'Producto Sephora': mkData.name || '',
      'Marca': mkData.brand || '',
      'Color/Variante': sv.label,
      'Precio USD': document.getElementById('bd-usd').textContent,
      'Total a pagar': document.getElementById('bd-pen').textContent,
      'Categor√≠a': document.getElementById('mk-category').textContent.trim(),
      'Indicaciones': document.getElementById('mk-notes').value || 'Sin indicaciones',
      '_Link Sephora': mkData.url || '',
      '_SKU Sephora': sv.sku_id,
      '_Imagen': imgUrl,
      '_Precio base USD': mkData.price || '',
      '_Cantidad solicitada': String(mkQtyVal),
    };
  }

  async function mkAddToCart() {
    // ‚îÄ‚îÄ 1. Calcular precio total en PEN ‚îÄ‚îÄ
    const price = mkData ? (mkData.price_numeric || 0) : 0;
    const q = mkQtyVal;
    const prod = price * q, tax = prod * MK_TAX_RATE;
    const usa = prod + tax, intl = MK_INTL_SHIP;
    const proc = prod * MK_COMMISSION;
    const totalUsd = usa + intl + proc;
    const totalPen = totalUsd * MK_RATE;

    // Obtener imagen principal del producto
    const mainImg = document.getElementById('mk-main-img');
    const imgUrl = (mkData.images && mkData.images[0]) || (mainImg ? mainImg.src : '');

    // ‚îÄ‚îÄ 2. Actualizar precio + imagen de la variante en Shopify via backend ‚îÄ‚îÄ
    const priceRes = await fetch(`${MK_API}/api/update-price`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ price: totalPen.toFixed(2), image: imgUrl })
    });
    const priceData = await priceRes.json();
    if (!priceData.success) {
      throw new Error('No se pudo fijar el precio: ' + (priceData.error || 'Error desconocido'));
    }

    // ‚îÄ‚îÄ 3. Breve espera para propagaci√≥n en Shopify ‚îÄ‚îÄ
    await new Promise(r => setTimeout(r, 500));

    // ‚îÄ‚îÄ 4. Limpiar items previos de importaci√≥n del carrito ‚îÄ‚îÄ
    try {
      const cartRes = await fetch('/cart.js');
      const cart = await cartRes.json();
      for (const item of cart.items) {
        if (String(item.variant_id) === String(MK_VARIANT_ID)) {
          await fetch('/cart/change.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: item.key, quantity: 0 })
          });
        }
      }
    } catch(e) { console.warn('No se pudo limpiar carrito previo:', e); }

    // ‚îÄ‚îÄ 5. Agregar al carrito con el precio ahora correcto ‚îÄ‚îÄ
    const payload = {
      id: MK_VARIANT_ID,
      quantity: 1,  // siempre 1 ‚Äî cantidad real va en propiedades
      properties: mkProps(),
    };
    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const errData = await res.json().catch(() => null);
      const msg = errData?.description || errData?.message || `Error HTTP ${res.status}`;
      throw new Error(msg);
    }
    const data = await res.json();
    mkUpdateCartCount();
    return data;
  }

  function mkUpdateCartCount() {
    fetch('/cart.js')
      .then(r => r.json())
      .then(cart => {
        const count = cart.item_count || 0;
        // Actualizar badges comunes de temas Shopify
        document.querySelectorAll(
          '.cart-count, .cart-count-bubble span, ' +
          '[data-cart-count], .js-cart-count, ' +
          '.site-header__cart-count, .header__cart-count, ' +
          '#cart-icon-bubble span'
        ).forEach(el => {
          el.textContent = count;
          if (el.closest('[hidden]')) el.closest('[hidden]').hidden = false;
        });
      }).catch(() => {});
  }

  async function mkComprar() {
    if (!mkData) return;
    const btn = document.querySelector('.mk-btn-comprar');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'Procesando...';
    try {
      await mkAddToCart();
      btn.textContent = 'Redirigiendo al pago...';
      window.location.href = '/checkout';
    } catch(e) {
      btn.disabled = false; btn.textContent = original;
      mkShowAlert('No se pudo agregar al carrito: ' + e.message);
    }
  }

  async function mkAgregar() {
    if (!mkData) return;
    const btn = document.querySelector('.mk-btn-carrito');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'Agregando...';
    try {
      await mkAddToCart();
      btn.textContent = 'Abriendo carrito...';
      // Redirigir a /cart para ver el producto con datos frescos
      window.location.href = '/cart';
    } catch(e) {
      btn.disabled = false; btn.textContent = original;
      mkShowAlert('No se pudo agregar al carrito: ' + e.message);
    }
  }

  function mkShowAlert(msg) {
    const al = document.getElementById('mk-alert');
    al.textContent = msg;
    al.style.display = 'block';
    setTimeout(() => { al.style.display = 'none'; }, 8000);
  }

  window.mkBuscar = mkBuscar;
  window.mkQty = mkQty;
  window.mkComprar = mkComprar;
  window.mkAgregar = mkAgregar;
  window.mkRecalc = mkRecalc;
  window.mkUpdateCartCount = mkUpdateCartCount;
</script>

{% schema %}
{
  "name": "Importador Sephora",
  "settings": [],
  "presets": [{ "name": "Importador Sephora" }]
}
{% endschema %}
