{% comment %}
  SECCI√ìN: Importador de productos Sephora ‚Äî Mak Beauty v2
  
  INSTALACI√ìN EN SHOPIFY (OS 2.0):
  1. Admin ‚Üí Online Store ‚Üí Themes ‚Üí Edit code
  2. En "Sections" ‚Üí sephora-import.liquid ‚Üí pegar TODO esto
  3. Guardar
{% endcomment %}

<style>
  .mk-importer {
    --mk-pink: #E48DA5;
    --mk-pink-dark: #D4729A;
    --mk-pink-light: #FDF2F5;
    --mk-pink-soft: #F8D7E0;
    --mk-accent: #C96B8B;
    --mk-text: #2D2D2D;
    --mk-text-muted: #7A7A7A;
    --mk-bg: #FAFAFA;
    --mk-white: #FFFFFF;
    --mk-border: #F0E0E5;
    --mk-success: #7CB69D;
    --mk-radius: 16px;
    --mk-shadow: 0 4px 20px rgba(228, 141, 165, 0.12);
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    max-width: 1100px;
    margin: 0 auto;
    padding: 30px 20px 60px;
    color: var(--mk-text);
  }

  /* ‚Äî Header ‚Äî */
  .mk-header { text-align: center; margin-bottom: 32px; }
  .mk-header h2 { font-size: 28px; font-weight: 700; margin: 0 0 6px; }
  .mk-header p { font-size: 14px; color: var(--mk-text-muted); margin: 0; }

  /* ‚Äî B√∫squeda ‚Äî */
  .mk-search {
    background: var(--mk-white); border-radius: var(--mk-radius);
    padding: 24px; box-shadow: var(--mk-shadow); margin-bottom: 28px;
    border: 1px solid var(--mk-border);
  }
  .mk-search-label {
    font-size: 13px; font-weight: 600; color: var(--mk-pink-dark);
    margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .mk-search-row { display: flex; gap: 12px; }
  .mk-search-input {
    flex: 1; padding: 14px 20px; border: 2px solid var(--mk-border);
    border-radius: 12px; font-size: 14px; font-family: inherit;
    transition: border-color 0.2s; background: var(--mk-bg);
  }
  .mk-search-input:focus { border-color: var(--mk-pink); outline: none; background: var(--mk-white); }
  .mk-search-input::placeholder { color: #C0A8B0; }
  .mk-btn-buscar {
    padding: 14px 32px;
    background: linear-gradient(135deg, var(--mk-pink), var(--mk-pink-dark));
    color: var(--mk-white); border: none; border-radius: 12px;
    font-size: 14px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: transform 0.15s, box-shadow 0.2s; white-space: nowrap;
  }
  .mk-btn-buscar:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(212,114,154,0.4); }
  .mk-btn-buscar:disabled { background: #D4C5CA; cursor: not-allowed; transform: none; }
  .mk-alert {
    display: none; background: #FFF8E1; border: 1px solid #FFD54F;
    border-radius: 10px; padding: 10px 16px; margin-top: 12px; font-size: 13px; color: #8D6E00;
  }

  /* ‚Äî Loading / Welcome ‚Äî */
  .mk-loading { display: none; text-align: center; padding: 70px 20px; }
  .mk-loading.visible { display: block; }
  .mk-loader {
    width: 44px; height: 44px; border: 4px solid var(--mk-pink-soft);
    border-top-color: var(--mk-pink-dark); border-radius: 50%;
    animation: mk-spin 0.7s linear infinite; margin: 0 auto 18px;
  }
  @keyframes mk-spin { to { transform: rotate(360deg); } }
  .mk-loading p { font-size: 14px; color: var(--mk-text-muted); }

  .mk-welcome {
    text-align: center; padding: 60px 20px; background: var(--mk-white);
    border-radius: var(--mk-radius); border: 2px dashed var(--mk-border);
  }
  .mk-welcome-icon {
    width: 64px; height: 64px; background: var(--mk-pink-light);
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; margin: 0 auto 16px; font-size: 28px;
  }
  .mk-welcome h3 { font-size: 20px; font-weight: 600; margin: 0 0 8px; }
  .mk-welcome p { font-size: 14px; color: var(--mk-text-muted); max-width: 380px; margin: 0 auto; line-height: 1.5; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRODUCTO LAYOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .mk-product { display: none; }
  .mk-product.visible {
    display: grid; grid-template-columns: 1fr 400px; gap: 28px; align-items: start;
  }
  .mk-panel {
    background: var(--mk-white); border-radius: var(--mk-radius);
    box-shadow: var(--mk-shadow); padding: 28px; border: 1px solid var(--mk-border);
  }

  /* ‚Äî Galer√≠a estilo Sephora ‚Äî */
  .mk-gallery { display: grid; grid-template-columns: 72px 1fr; gap: 12px; margin-bottom: 20px; }
  .mk-gallery-thumbs {
    display: flex; flex-direction: column; gap: 8px;
    max-height: 500px; overflow-y: auto; scrollbar-width: thin;
    scrollbar-color: var(--mk-pink-soft) transparent;
  }
  .mk-gallery-thumbs::-webkit-scrollbar { width: 4px; }
  .mk-gallery-thumbs::-webkit-scrollbar-thumb { background: var(--mk-pink-soft); border-radius: 4px; }
  .mk-gallery-thumb {
    width: 64px; height: 64px; border-radius: 8px; object-fit: cover;
    border: 2px solid var(--mk-border); cursor: pointer;
    transition: border-color 0.2s, transform 0.15s; flex-shrink: 0;
  }
  .mk-gallery-thumb:hover { border-color: var(--mk-pink); transform: scale(1.05); }
  .mk-gallery-thumb.active { border-color: var(--mk-pink-dark); box-shadow: 0 0 0 2px var(--mk-pink-soft); }
  .mk-gallery-main {
    width: 100%; aspect-ratio: 1; border-radius: 14px; overflow: hidden;
    background: var(--mk-bg); display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .mk-gallery-main img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
  .mk-gallery-main img:hover { transform: scale(1.05); }
  .mk-img-count {
    position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6);
    color: #fff; font-size: 11px; padding: 4px 10px; border-radius: 20px;
  }

  /* ‚Äî Swatches circulares ‚Äî */
  .mk-swatches-row {
    display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
    margin-bottom: 20px; padding: 12px 0; border-top: 1px solid var(--mk-border);
    border-bottom: 1px solid var(--mk-border);
  }
  .mk-swatch-circle { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
  .mk-swatch-img {
    width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
    border: 2px solid var(--mk-border); transition: all 0.2s;
  }
  .mk-swatch-circle:hover .mk-swatch-img,
  .mk-swatch-circle.active .mk-swatch-img { border-color: var(--mk-pink-dark); transform: scale(1.1); }
  .mk-swatch-name {
    font-size: 9px; color: var(--mk-text-muted); text-align: center;
    max-width: 50px; line-height: 1.2; word-break: break-word;
  }

  /* ‚Äî Info ‚Äî */
  .mk-brand {
    font-size: 13px; font-weight: 700; color: var(--mk-pink-dark);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;
  }
  .mk-title { font-size: 20px; font-weight: 700; margin: 0 0 6px; line-height: 1.3; }
  .mk-rating { font-size: 13px; color: var(--mk-text-muted); margin-bottom: 10px; }
  .mk-rating .stars { color: #FFB800; letter-spacing: 1px; }
  .mk-price-inline {
    font-size: 22px; font-weight: 800; color: var(--mk-text); margin-bottom: 6px;
  }
  .mk-color-label { font-size: 13px; color: var(--mk-text-muted); margin-bottom: 16px; }
  .mk-color-label strong { color: var(--mk-text); }

  .mk-field-label {
    display: block; font-size: 12px; font-weight: 600; color: var(--mk-text-muted);
    margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .mk-field {
    width: 100%; padding: 10px 14px; border: 1.5px solid var(--mk-border);
    border-radius: 10px; font-size: 14px; font-family: inherit;
    background: var(--mk-bg); margin-bottom: 14px; box-sizing: border-box;
  }
  .mk-field:focus { border-color: var(--mk-pink); outline: none; }

  /* ‚Äî Variantes chips ‚Äî */
  .mk-tones-wrap { margin-bottom: 18px; }
  .mk-tones { display: flex; flex-wrap: wrap; gap: 8px; }
  .mk-tone {
    border: 2px solid var(--mk-border); border-radius: 10px; padding: 8px 14px;
    text-align: center; cursor: pointer; font-size: 12px; font-family: inherit;
    font-weight: 500; background: var(--mk-white); transition: all 0.2s;
  }
  .mk-tone:hover { border-color: var(--mk-pink); background: var(--mk-pink-light); }
  .mk-tone.picked { border-color: var(--mk-pink-dark); background: var(--mk-pink-light); color: var(--mk-pink-dark); font-weight: 600; }
  .mk-tone.oos { opacity: 0.4; text-decoration: line-through; cursor: not-allowed; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL DERECHO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .mk-summary { position: sticky; top: 20px; }
  .mk-summary-title {
    font-size: 16px; font-weight: 700; margin-bottom: 16px;
    padding-bottom: 12px; border-bottom: 2px solid var(--mk-pink-soft);
  }

  /* ‚Äî Desglose ‚Äî */
  .mk-bd { margin-bottom: 16px; }
  .mk-bd-section { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--mk-border); }
  .mk-bd-section:last-child { border-bottom: none; margin-bottom: 0; }
  .mk-bd-header {
    font-size: 11px; font-weight: 700; color: var(--mk-pink-dark);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px;
  }
  .mk-bd-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 13px; }
  .mk-bd-row .lbl { color: var(--mk-text-muted); }
  .mk-bd-row .val { font-weight: 600; color: var(--mk-text); }
  .mk-bd-row .val.free { color: var(--mk-success); }
  .mk-bd-row .val.hl { color: var(--mk-pink-dark); font-weight: 700; }
  .mk-bd-sub {
    display: flex; justify-content: space-between; padding: 6px 0 0;
    margin-top: 4px; border-top: 1px dashed var(--mk-border);
  }
  .mk-bd-sub .lbl { font-weight: 600; font-size: 13px; }
  .mk-bd-sub .val { font-weight: 700; color: var(--mk-pink-dark); font-size: 13px; }
  .mk-bd-total {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 0 0; margin-top: 4px; border-top: 2px solid var(--mk-pink-dark);
  }
  .mk-bd-total .lbl { font-size: 15px; font-weight: 700; }
  .mk-bd-total .val { font-size: 26px; font-weight: 800; color: var(--mk-pink-dark); }

  /* ‚Äî Delivery ‚Äî */
  .mk-delivery-box {
    background: linear-gradient(135deg, #F0FAF4, #E8F5EE);
    border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; border: 1px solid #C8E6D0;
  }
  .mk-delivery-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
  .mk-delivery-date { font-weight: 700; color: #3D8B5E; font-size: 14px; }

  /* ‚Äî Qty ‚Äî */
  .mk-qty-section {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; padding: 12px 16px; background: var(--mk-pink-light); border-radius: 12px;
  }
  .mk-qty-label { font-size: 14px; font-weight: 600; }
  .mk-qty-controls { display: flex; align-items: center; gap: 14px; }
  .mk-qty-btn {
    width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--mk-border);
    background: var(--mk-white); font-size: 18px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    color: var(--mk-text); font-family: inherit;
  }
  .mk-qty-btn:hover { border-color: var(--mk-pink); background: var(--mk-pink-light); }
  .mk-qty-num { font-size: 20px; font-weight: 700; min-width: 30px; text-align: center; }

  /* ‚Äî Buttons ‚Äî */
  .mk-btn-comprar {
    width: 100%; padding: 16px;
    background: linear-gradient(135deg, var(--mk-pink), var(--mk-pink-dark));
    color: var(--mk-white); border: none; border-radius: 14px;
    font-size: 16px; font-weight: 700; font-family: inherit; cursor: pointer;
    margin-bottom: 10px; transition: transform 0.15s, box-shadow 0.2s;
  }
  .mk-btn-comprar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,114,154,0.35); }
  .mk-btn-carrito {
    width: 100%; padding: 14px; background: var(--mk-white);
    color: var(--mk-pink-dark); border: 2px solid var(--mk-pink);
    border-radius: 14px; font-size: 15px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: all 0.2s; margin-bottom: 14px;
  }
  .mk-btn-carrito:hover { background: var(--mk-pink-light); }
  .mk-secure {
    display: flex; align-items: center; justify-content: center;
    gap: 6px; font-size: 12px; color: var(--mk-text-muted);
  }

  .mk-notes-section { margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--mk-border); }

  /* ‚Äî Toast ‚Äî */
  .mk-toast {
    position: fixed; bottom: 30px; right: 30px; background: var(--mk-white);
    border: 2px solid var(--mk-success); border-radius: 14px; padding: 16px 24px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15); display: none; z-index: 9999;
    animation: mk-up 0.3s ease-out; font-family: inherit;
  }
  .mk-toast.show { display: flex; align-items: center; gap: 10px; }
  @keyframes mk-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* ‚Äî Responsive ‚Äî */
  @media (max-width: 820px) {
    .mk-product.visible { grid-template-columns: 1fr; }
    .mk-search-row { flex-direction: column; }
    .mk-summary { position: static; }
    .mk-gallery { grid-template-columns: 56px 1fr; gap: 8px; }
    .mk-gallery-thumb { width: 48px; height: 48px; }
    .mk-gallery-thumbs { max-height: 350px; }
  }
</style>

<div class="mk-importer">
  <div class="mk-header">
    <h2>Importar desde Sephora USA</h2>
    <p>Pega el enlace del producto y te lo traemos hasta tu puerta</p>
  </div>

  <div class="mk-search">
    <div class="mk-search-label">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      Pega el link del producto de Sephora
    </div>
    <div class="mk-search-row">
      <input type="text" class="mk-search-input" id="mk-url" placeholder="https://www.sephora.com/product/...">
      <button class="mk-btn-buscar" id="mk-btn" onclick="mkBuscar()">Buscar Producto</button>
    </div>
    <div class="mk-alert" id="mk-alert"></div>
  </div>

  <div class="mk-loading" id="mk-loading">
    <div class="mk-loader"></div>
    <p>Consultando disponibilidad...</p>
  </div>

  <div class="mk-welcome" id="mk-welcome">
    <div class="mk-welcome-icon">‚ú®</div>
    <h3>Tu pr√≥ximo favorito te espera</h3>
    <p>Copia el enlace de cualquier producto de sephora.com y p√©galo arriba. Nosotros hacemos el resto.</p>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRODUCTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="mk-product" id="mk-product">
    <!-- PANEL IZQUIERDO -->
    <div class="mk-panel">
      <div class="mk-gallery">
        <div class="mk-gallery-thumbs" id="mk-gallery-thumbs"></div>
        <div class="mk-gallery-main">
          <img id="mk-main-img" src="" alt="Producto">
          <span class="mk-img-count" id="mk-img-count"></span>
        </div>
      </div>

      <div class="mk-swatches-row" id="mk-swatches-row" style="display:none;"></div>

      <div class="mk-brand" id="mk-brand"></div>
      <h3 class="mk-title" id="mk-title"></h3>
      <div class="mk-rating" id="mk-rating" style="display:none;"></div>
      <div class="mk-price-inline" id="mk-price-inline"></div>
      <div class="mk-color-label" id="mk-color-label" style="display:none;"></div>

      <div class="mk-tones-wrap" id="mk-tones-wrap" style="display:none;">
        <label class="mk-field-label" id="mk-tones-label">Tono / Variante</label>
        <div class="mk-tones" id="mk-tones"></div>
      </div>

      <label class="mk-field-label">Categor√≠a</label>
      <select class="mk-field" id="mk-category">
        <option>Maquillaje</option><option>Cuidado de la Piel</option><option>Cabello</option>
        <option>Fragancia</option><option>Accesorios</option>
      </select>

      <div class="mk-notes-section">
        <label class="mk-field-label">Indicaciones especiales</label>
        <textarea class="mk-field" id="mk-notes" rows="2" placeholder="Color exacto, talla, presentaci√≥n..."></textarea>
      </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="mk-panel mk-summary">
      <div class="mk-summary-title">Resumen de tu pedido</div>

      <div class="mk-bd">
        <div class="mk-bd-section">
          <div class="mk-bd-header">üá∫üá∏ Compra en USA</div>
          <div class="mk-bd-row"><span class="lbl">Producto(s)</span><span class="val" id="bd-prod">$ 0.00</span></div>
          <div class="mk-bd-row"><span class="lbl">Taxes (7%)</span><span class="val" id="bd-tax">$ 0.00</span></div>
          <div class="mk-bd-sub"><span class="lbl">Total en USA</span><span class="val" id="bd-usa">$ 0.00</span></div>
        </div>

        <div class="mk-bd-section">
          <div class="mk-bd-header">üáµüá™ Env√≠o a Per√∫</div>
          <div class="mk-bd-row"><span class="lbl">Env√≠o internacional <small id="bd-weight">(~0.5 Kg)</small></span><span class="val" id="bd-ship">$ 19.00</span></div>
          <div class="mk-bd-sub"><span class="lbl">Total tra√≠da</span><span class="val" id="bd-traida">$ 19.00</span></div>
        </div>

        <div class="mk-bd-section">
          <div class="mk-bd-header">üõ°Ô∏è Servicio Mak Beauty</div>
          <div class="mk-bd-row"><span class="lbl">Procesamiento</span><span class="val" id="bd-proc">$ 0.00</span></div>
          <div class="mk-bd-row"><span class="lbl">30 d√≠as de garant√≠a</span><span class="val free">Gratis</span></div>
        </div>

        <div class="mk-bd-section" style="border-bottom:none;">
          <div class="mk-bd-row"><span class="lbl" style="font-weight:600">Total (USD)</span><span class="val hl" id="bd-usd">$ 0.00</span></div>
          <div class="mk-bd-total"><span class="lbl">Total a pagar</span><span class="val" id="bd-pen">S/ 0.00</span></div>
        </div>
      </div>

      <div class="mk-delivery-box">
        <div class="mk-delivery-row">
          <span>Llega antes del</span>
          <span class="mk-delivery-date" id="mk-arrival">--</span>
        </div>
      </div>

      <div class="mk-qty-section">
        <span class="mk-qty-label">Cantidad:</span>
        <div class="mk-qty-controls">
          <button class="mk-qty-btn" onclick="mkQty(-1)">‚àí</button>
          <span class="mk-qty-num" id="mk-qty">1</span>
          <button class="mk-qty-btn" onclick="mkQty(1)">+</button>
        </div>
      </div>

      <button class="mk-btn-comprar" onclick="mkComprar()">Comprar ahora</button>
      <button class="mk-btn-carrito" onclick="mkAgregar()">Agregar al carrito</button>

      <div class="mk-secure">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Pago 100% seguro ¬∑ Garant√≠a de autenticidad
      </div>
    </div>
  </div>

  <div class="mk-toast" id="mk-toast">
    <span style="font-size:22px">‚úÖ</span>
    <span style="font-size:14px;font-weight:600">Producto agregado al carrito</span>
  </div>
</div>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONFIGURACI√ìN
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const MK_API = 'web-production-56b31.up.railway.app';
  const MK_RATE       = 3.45;    // USD ‚Üí PEN
  const MK_TAX_RATE   = 0.07;    // 7 % sales tax USA
  const MK_INTL_SHIP  = 20.00;   // env√≠o int. base USD
  const MK_COMMISSION = 0.15;    // 15 % procesamiento
  const MK_SYMBOL     = 'S/';
  const MK_VARIANT_ID = 51967182143801;

  let mkData = null, mkQtyVal = 1;

  /* ‚îÄ‚îÄ Buscar ‚îÄ‚îÄ */
  async function mkBuscar() {
    const url = document.getElementById('mk-url').value.trim();
    const al  = document.getElementById('mk-alert');
    const btn = document.getElementById('mk-btn');
    al.style.display = 'none';
    if (!url || !url.includes('sephora.com')) {
      al.textContent = 'Por favor ingresa un enlace v√°lido de sephora.com';
      al.style.display = 'block'; return;
    }
    document.getElementById('mk-loading').classList.add('visible');
    document.getElementById('mk-welcome').style.display = 'none';
    document.getElementById('mk-product').classList.remove('visible');
    btn.disabled = true; btn.textContent = 'Buscando...';

    try {
      const res = await fetch(`${MK_API}/api/scrape`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'ngrok-skip-browser-warning':'true' },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      if (!data.success) {
        al.textContent = data.error || 'No pudimos obtener el producto.';
        al.style.display = 'block';
        document.getElementById('mk-welcome').style.display = ''; return;
      }
      mkData = data;
      mkRender(data);
    } catch(e) {
      al.textContent = 'Error de conexi√≥n. Intenta de nuevo.';
      al.style.display = 'block';
      document.getElementById('mk-welcome').style.display = '';
    } finally {
      document.getElementById('mk-loading').classList.remove('visible');
      btn.disabled = false; btn.textContent = 'Buscar Producto';
    }
  }
  document.getElementById('mk-url').addEventListener('keydown', e => { if (e.key === 'Enter') mkBuscar(); });

  /* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
  function mkRender(d) {
    document.getElementById('mk-brand').textContent = d.brand || '';
    document.getElementById('mk-title').textContent = d.name || '';

    // Rating
    const ratingEl = document.getElementById('mk-rating');
    if (d.rating) {
      const full = Math.floor(d.rating);
      const half = d.rating - full >= 0.3 ? '¬Ω' : '';
      ratingEl.innerHTML = `<span class="stars">${'‚òÖ'.repeat(full)}${half}${'‚òÜ'.repeat(5 - full - (half?1:0))}</span> ${d.rating} ¬∑ ${d.review_count || 0} rese√±as`;
      ratingEl.style.display = '';
    } else { ratingEl.style.display = 'none'; }

    // Precio inline
    document.getElementById('mk-price-inline').textContent = d.price || '';

    const mainImg = document.getElementById('mk-main-img');
    const gThumbs = document.getElementById('mk-gallery-thumbs');
    const swRow   = document.getElementById('mk-swatches-row');
    gThumbs.innerHTML = ''; swRow.innerHTML = '';

    const variants = d.color_variants || [];
    const imgs     = d.images || [];

    /**
     * Convierte una URL de swatch (+sw) en la imagen completa del SKU.
     * Sephora usa: /productimages/sku/s{SKUID}+sw.jpg  ‚Üí swatch
     *              /productimages/sku/s{SKUID}.jpg      ‚Üí imagen completa
     * Si no tiene +sw, devuelve la URL tal cual.
     */
    function mkSwatchToFull(swatchUrl) {
      if (!swatchUrl) return '';
      // Quitar +sw para obtener la imagen completa del SKU
      return swatchUrl.replace(/\+sw/gi, '');
    }

    /**
     * Muestra una imagen en el main, con fallback al swatch directo si falla.
     */
    function mkShowImage(url, fallbackUrl) {
      mainImg.onerror = function() {
        // Si la imagen completa falla, mostrar swatch expandido o primera imagen
        mainImg.onerror = null;
        if (fallbackUrl && fallbackUrl !== url) {
          mainImg.src = fallbackUrl;
        } else if (imgs.length > 0) {
          mainImg.src = imgs[0];
        }
      };
      mainImg.src = url;
    }

    // ‚îÄ‚îÄ Galer√≠a thumbnails verticales ‚îÄ‚îÄ
    if (imgs.length > 0) {
      mainImg.src = imgs[0];
      document.getElementById('mk-img-count').textContent = imgs.length + ' fotos';
      imgs.forEach((url, i) => {
        const t = document.createElement('img');
        t.src = url; t.className = 'mk-gallery-thumb' + (i===0?' active':'');
        t.loading = 'lazy';
        t.onclick = () => {
          mainImg.onerror = null;
          mainImg.src = url;
          gThumbs.querySelectorAll('.mk-gallery-thumb').forEach(x => x.classList.remove('active'));
          t.classList.add('active');
        };
        t.onerror = function(){ this.style.display='none'; };
        gThumbs.appendChild(t);
      });
    }

    // ‚îÄ‚îÄ Swatches circulares ‚îÄ‚îÄ
    if (variants.length > 0 && variants.some(v => v.image)) {
      swRow.style.display = 'flex';
      variants.forEach((v, i) => {
        if (!v.image) return;
        const c = document.createElement('div');
        c.className = 'mk-swatch-circle' + (v.selected?' active':'');
        const im = document.createElement('img');
        im.src = v.image; im.className = 'mk-swatch-img'; im.loading = 'lazy';
        const nm = document.createElement('span');
        nm.className = 'mk-swatch-name';
        nm.textContent = (v.label||'').split(' ').slice(0,2).join(' ');
        c.appendChild(im); c.appendChild(nm);
        c.onclick = () => {
          // Intentar mostrar imagen completa del SKU, con fallback al swatch
          const fullUrl = mkSwatchToFull(v.image);
          mkShowImage(fullUrl, v.image);
          swRow.querySelectorAll('.mk-swatch-circle').forEach(x => x.classList.remove('active'));
          c.classList.add('active');
          document.querySelectorAll('.mk-tone').forEach((t,idx) => t.classList.toggle('picked', idx===i));
          // Quitar active de thumbnails de galer√≠a
          gThumbs.querySelectorAll('.mk-gallery-thumb').forEach(x => x.classList.remove('active'));
          mkUpdateColorLabel(v.label);
          mkRecalc();
        };
        im.onerror = function(){ c.style.display='none'; };
        swRow.appendChild(c);
      });
    } else { swRow.style.display = 'none'; }

    // ‚îÄ‚îÄ Variantes chips ‚îÄ‚îÄ
    const tw = document.getElementById('mk-tones-wrap');
    const tg = document.getElementById('mk-tones');
    if (variants.length > 0) {
      tw.style.display = ''; tg.innerHTML = '';
      variants.forEach((v, i) => {
        const ch = document.createElement('div');
        let lbl = (v.label || `Tono ${i+1}`).replace(/^Select\s*/i, '');
        ch.className = 'mk-tone' + (v.selected?' picked':'') + (v.out_of_stock?' oos':'');
        ch.textContent = lbl;
        if (!v.out_of_stock) {
          ch.onclick = () => {
            tg.querySelectorAll('.mk-tone').forEach(x => x.classList.remove('picked'));
            ch.classList.add('picked');
            swRow.querySelectorAll('.mk-swatch-circle').forEach((c,idx) => c.classList.toggle('active',idx===i));
            // Quitar active de thumbnails de galer√≠a
            gThumbs.querySelectorAll('.mk-gallery-thumb').forEach(x => x.classList.remove('active'));
            if (v.image) {
              const fullUrl = mkSwatchToFull(v.image);
              mkShowImage(fullUrl, v.image);
            }
            mkUpdateColorLabel(lbl);
            mkRecalc();
          };
        }
        tg.appendChild(ch);
      });
      // Color label
      const sel = variants.find(v => v.selected);
      if (sel) mkUpdateColorLabel(sel.label);
    } else { tw.style.display = 'none'; }

    // Fecha entrega
    const arr = new Date(); arr.setDate(arr.getDate() + 21);
    const m = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    document.getElementById('mk-arrival').textContent = `${arr.getDate()} de ${m[arr.getMonth()]} del ${arr.getFullYear()}`;

    // Categor√≠a autom√°tica
    const cat = (d.category || '').toLowerCase();
    const catSel = document.getElementById('mk-category');
    if (cat.includes('skin') || cat.includes('piel')) catSel.value = 'Cuidado de la Piel';
    else if (cat.includes('hair') || cat.includes('cabel')) catSel.value = 'Cabello';
    else if (cat.includes('fragr') || cat.includes('perfum')) catSel.value = 'Fragancia';
    else catSel.value = 'Maquillaje';

    mkQtyVal = 1; document.getElementById('mk-qty').textContent = '1';
    mkRecalc();
    document.getElementById('mk-product').classList.add('visible');
    document.getElementById('mk-welcome').style.display = 'none';
  }

  function mkUpdateColorLabel(lbl) {
    const el = document.getElementById('mk-color-label');
    if (lbl) {
      el.innerHTML = `Color: <strong>${lbl.replace(/^Select\s*/i,'')}</strong>`;
      el.style.display = '';
    } else { el.style.display = 'none'; }
  }

  /* ‚îÄ‚îÄ Recalcular precios ‚îÄ‚îÄ */
  function mkRecalc() {
    const price = mkData ? (mkData.price_numeric || 0) : 0;
    const q = mkQtyVal;

    const prod   = price * q;
    const tax    = prod * MK_TAX_RATE;
    const sShip  = 0; // Sephora free shipping
    const usa    = prod + tax + sShip;
    const intl   = MK_INTL_SHIP;
    const imp    = 0;
    const traida = intl + imp;
    const proc   = prod * MK_COMMISSION;
    const usd    = usa + traida + proc;
    const pen    = usd * MK_RATE;

    document.getElementById('bd-prod').textContent      = `$ ${prod.toFixed(2)}`;
    document.getElementById('bd-tax').textContent        = `$ ${tax.toFixed(2)}`;
    document.getElementById('bd-store-ship').textContent = sShip > 0 ? `$ ${sShip.toFixed(2)}` : 'Gratis';
    document.getElementById('bd-store-ship').className   = 'val' + (sShip===0?' free':'');
    document.getElementById('bd-usa').textContent        = `$ ${usa.toFixed(2)}`;
    document.getElementById('bd-ship').textContent       = `$ ${intl.toFixed(2)}`;
    document.getElementById('bd-imp').textContent        = imp > 0 ? `$ ${imp.toFixed(2)}` : 'Gratis';
    document.getElementById('bd-imp').className          = 'val' + (imp===0?' free':'');
    document.getElementById('bd-traida').textContent     = `$ ${traida.toFixed(2)}`;
    document.getElementById('bd-proc').textContent       = `$ ${proc.toFixed(2)}`;
    document.getElementById('bd-usd').textContent        = `$ ${usd.toFixed(2)}`;
    document.getElementById('bd-pen').textContent        = `${MK_SYMBOL} ${pen.toFixed(2)}`;
  }

  function mkQty(d) { mkQtyVal = Math.max(1, mkQtyVal + d); document.getElementById('mk-qty').textContent = mkQtyVal; mkRecalc(); }

  function mkProps() {
    const tone = document.querySelector('.mk-tone.picked');
    return {
      '_Producto Sephora': mkData.name,
      '_Marca': mkData.brand || '',
      '_Color/Variante': tone ? tone.textContent.trim() : 'N/A',
      '_Link Sephora': mkData.url,
      '_Precio USD': document.getElementById('bd-usd').textContent,
      '_Precio Total': document.getElementById('bd-pen').textContent,
      '_Categor√≠a': document.getElementById('mk-category').value,
      '_Cantidad': mkQtyVal,
      '_Indicaciones': document.getElementById('mk-notes').value || 'Sin indicaciones'
    };
  }

  function mkComprar() {
    if (!mkData) return;
    fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id:MK_VARIANT_ID, quantity:mkQtyVal, properties:mkProps() })
    }).then(r => { if(!r.ok) throw 0; return r.json(); })
      .then(() => window.location.href='/checkout')
      .catch(() => alert('Error. Intenta de nuevo.'));
  }

  function mkAgregar() {
    if (!mkData) return;
    fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id:MK_VARIANT_ID, quantity:mkQtyVal, properties:mkProps() })
    }).then(r => { if(!r.ok) throw 0; return r.json(); })
      .then(() => {
        const t = document.getElementById('mk-toast');
        t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
      }).catch(() => alert('Error al agregar al carrito.'));
  }

  window.mkBuscar = mkBuscar;
  window.mkQty = mkQty;
  window.mkComprar = mkComprar;
  window.mkAgregar = mkAgregar;
  window.mkRecalc = mkRecalc;
</script>

{% schema %}
{
  "name": "Importador Sephora",
  "settings": [],
  "presets": [{ "name": "Importador Sephora" }]
}
{% endschema %}
